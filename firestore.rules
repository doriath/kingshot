rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is an admin of the space
    function isAdmin(spaceId) {
      let space = get(/databases/$(database)/documents/spaces/$(spaceId));
      return isAuthenticated() && request.auth.uid in space.data.admins;
    }

    // Helper function to check if user is a global admin
    function isGlobalAdmin() {
      return isAuthenticated() && exists(/databases/$(database)/documents/globalAdmins/$(request.auth.uid));
    }

    match /spaces/{spaceId} {
      // Anyone authenticated can read spaces (to see the list)
      allow read: if isAuthenticated();
      
      // Authenticated users can create a space
      // We validate that the creating user sets themselves as admin
      allow create: if isAuthenticated() 
                    && request.resource.data.admins.hasAll([request.auth.uid]);
      
      // Only admins can update the space (e.g. add more admins)
      allow update: if isAdmin(spaceId);
      
      // Only admins can delete
      allow delete: if isAdmin(spaceId);

      match /rallies/{rallyId} {
        // Viewers (authenticated) can read rallies
        allow read: if isAuthenticated();
        
        // Only admins can create/delete rallies
        allow create, delete: if isAdmin(spaceId);
      }

      match /enemies/{enemyId} {
        // Viewers (authenticated) can read enemies
        allow read: if isAuthenticated();
        
        // Only admins can create/update enemies
        allow create, update: if isAdmin(spaceId);
      }
    }

    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /characters/{characterId} {
      // Allow read if the character belongs to the user
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Create is restricted to admins
      allow create: if isGlobalAdmin(); 
      
      // Allow update if the character belongs to the user (e.g. name, server, alliance)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Allow delete if the character belongs to the user (they can remove it)
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /characterRegistrations/{characterId} {
      // Allow read if the registration belongs to the user OR is admin
      allow read: if (isAuthenticated() && resource.data.userId == request.auth.uid) || isGlobalAdmin();
      
      // Allow create if authenticated and the userId matches the user
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Allow update if the registration belongs to the user (e.g. name, server)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Allow delete if the registration belongs to the user (cancel request) OR is admin (reject/approve)
      allow delete: if (isAuthenticated() && resource.data.userId == request.auth.uid) || isGlobalAdmin();
    }
    
    match /globalAdmins/{userId} {
      allow read: if isAuthenticated();
    }

    match /alliances/{allianceId} {
      allow read: if true;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.admins;
    }

    match /vikingsEvents/{eventId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/alliances/$(request.resource.data.allianceId)).data.admins;
      allow update, delete: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/alliances/$(resource.data.allianceId)).data.admins;
    }

    match /swordlandEvents/{eventId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/alliances/$(request.resource.data.allianceId)).data.admins;
      allow update, delete: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/alliances/$(resource.data.allianceId)).data.admins;
    }

    match /vikingsRegistrations/{docId} {
      // Allow read if authenticated
      allow read: if isAuthenticated();
      
      // Allow write if authenticated and the registration belongs to the user
      allow write: if isAuthenticated() && (
        (request.resource.data.userId == request.auth.uid) || 
        (resource.data.userId == request.auth.uid)
      );
    }

    // Helper for SvS Event Admins
    function isSvsEventAdmin(eventId) {
      let evt = get(/databases/$(database)/documents/svsPrepEvents/$(eventId));
      return isAuthenticated() && (request.auth.uid in evt.data.admins);
    }

    match /svsPrepEvents/{eventId} {
      // Anyone can read events
      allow read: if true;
      // Global admins can do anything. Event admins can update their event.
      allow create: if isGlobalAdmin();
      allow update: if isGlobalAdmin() || (isAuthenticated() && request.auth.uid in resource.data.admins);
      allow delete: if isGlobalAdmin();
    }

    match /svsPrepRegistrations/{regId} {
        // Users can read their own. Global Admins can read all.
        // Event Admins can read registrations for their event.
        allow read: if isAuthenticated() && (
            resource.data.userId == request.auth.uid || 
            isGlobalAdmin() ||
            isSvsEventAdmin(resource.data.eventId)
        );
        // Create: Owner or Admin
        allow create: if isAuthenticated() && (
            request.resource.data.userId == request.auth.uid ||
            isGlobalAdmin() ||
            isSvsEventAdmin(request.resource.data.eventId)
        );
        
        // Update: Owner (must stay owner) or Admin
        allow update: if isAuthenticated() && (
            (resource.data.userId == request.auth.uid && request.resource.data.userId == request.auth.uid) ||
            isGlobalAdmin() ||
            isSvsEventAdmin(resource.data.eventId)
        );

        // Delete: Owner or Admin
        allow delete: if isAuthenticated() && (
            resource.data.userId == request.auth.uid ||
            isGlobalAdmin() ||
            isSvsEventAdmin(resource.data.eventId)
        );
    }
  }
}
