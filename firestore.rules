rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is an admin of the space
    function isAdmin(spaceId) {
      let space = get(/databases/$(database)/documents/spaces/$(spaceId));
      return isAuthenticated() && request.auth.uid in space.data.admins;
    }

    match /spaces/{spaceId} {
      // Anyone authenticated can read spaces (to see the list)
      allow read: if isAuthenticated();
      
      // Authenticated users can create a space
      // We validate that the creating user sets themselves as admin
      allow create: if isAuthenticated() 
                    && request.resource.data.admins.hasAll([request.auth.uid]);
      
      // Only admins can update the space (e.g. add more admins)
      allow update: if isAdmin(spaceId);
      
      // Only admins can delete
      allow delete: if isAdmin(spaceId);

      match /rallies/{rallyId} {
        // Viewers (authenticated) can read rallies
        allow read: if isAuthenticated();
        
        // Only admins can create/delete rallies
        allow create, delete: if isAdmin(spaceId);
      }

      match /enemies/{enemyId} {
        // Viewers (authenticated) can read enemies
        allow read: if isAuthenticated();
        
        // Only admins can create/update enemies
        allow create, update: if isAdmin(spaceId);
      }
    }
  }
}
