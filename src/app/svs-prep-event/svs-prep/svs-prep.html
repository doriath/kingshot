<div class="container">
    @if (loading()) {
    <div class="loading">Loading events...</div>
    } @else {
    @if (currentEvent(); as evt) {
    <div class="header">
        <h1>SvS Prep: Server {{ evt.server }}</h1>
        <p class="subtitle">Battle Date: {{ evt.date.seconds * 1000 | date:'longDate' }}</p>
    </div>

    <div class="character-list">
        @for (char of characterViewModels(); track char.id) {
        <div class="character-card">
            <div class="character-header" (click)="toggleExpand(char.id)">
                <div class="char-info">
                    <h3>{{ char.name }}</h3>
                    <span class="server-badge">Server {{ char.server }}</span>
                </div>
                <div class="status">
                    @if (char.isRegistered) {
                    <div class="registered-summary">
                        <span class="badge registered">Registered</span>
                        @if (char.summary) {
                        <span class="summary-text">{{ char.summary }}</span>
                        }
                    </div>
                    } @else {
                    <span class="badge not-registered">Not Registered</span>
                    }

                    @if (char.warnings && char.warnings.length > 0) {
                    <span class="badge warning" title="Action Required: Incomplete Registration">⚠ Action
                        Required</span>
                    }
                    <span class="arrow" [class.expanded]="expandedCharacterId() === char.id">▼</span>
                </div>
            </div>

            @if (expandedCharacterId() === char.id) {
            <div class="character-content">
                @if (currentEditWarnings().length > 0) {
                <div class="warning-alert">
                    <h4>⚠ Attention Needed</h4>
                    <ul>
                        @for (warn of currentEditWarnings(); track warn) {
                        <li>{{ warn }}</li>
                        }
                    </ul>
                </div>
                }

                <div class="time-controls">
                    <div class="quick-entry">
                        <label>Quick Entry (e.g. "10-12", "14-16, 18-20")</label>
                        <div class="input-group">
                            <input type="text" [ngModel]="timeRangeInput()" (ngModelChange)="timeRangeInput.set($event)"
                                placeholder="Enter time ranges...">
                            <button class="btn-secondary" (click)="applyTimeRange()">Apply</button>
                        </div>
                    </div>

                    <div class="toggle-control">
                        <label>
                            <input type="checkbox" [ngModel]="sameTimeForAll()"
                                (ngModelChange)="sameTimeForAll.set($event)">
                            Same time for all days
                        </label>
                    </div>
                </div>

                @if (sameTimeForAll()) {
                <div class="boost-section">
                    <h4>General Availability (Applied to All Days)</h4>
                    <p class="section-hint">Select times below to apply to Construction, Research, and Troops.</p>
                    <div class="time-grid" (mouseleave)="stopDrag()"
                        (touchmove)="handleTouchMove($event, 'construction')">
                        @for (time of timeSlots(); track time) {
                        <button class="time-slot" [attr.data-time]="time"
                            [class.selected]="isSelected('construction', time)"
                            (mousedown)="startDrag($event, 'construction', time)"
                            (mouseenter)="onMouseEnter('construction', time)" (mouseup)="stopDrag()"
                            (touchstart)="startDrag($event, 'construction', time)" (touchend)="stopDrag()">
                            {{ time }}
                        </button>
                        }
                    </div>
                </div>
                } @else {
                <div class="boost-section">
                    <h4>Construction ({{ evt.constructionDay | titlecase }})</h4>
                    <div class="time-grid" (mouseleave)="stopDrag()"
                        (touchmove)="handleTouchMove($event, 'construction')">
                        @for (time of timeSlots(); track time) {
                        <button class="time-slot" [attr.data-time]="time"
                            [class.selected]="isSelected('construction', time)"
                            (mousedown)="startDrag($event, 'construction', time)"
                            (mouseenter)="onMouseEnter('construction', time)" (mouseup)="stopDrag()"
                            (touchstart)="startDrag($event, 'construction', time)" (touchend)="stopDrag()">
                            {{ time }}
                        </button>
                        }
                    </div>
                </div>

                <div class="boost-section">
                    <h4>Research ({{ evt.researchDay | titlecase }})</h4>
                    <div class="time-grid" (mouseleave)="stopDrag()" (touchmove)="handleTouchMove($event, 'research')">
                        @for (time of timeSlots(); track time) {
                        <button class="time-slot" [attr.data-time]="time"
                            [class.selected]="isSelected('research', time)"
                            (mousedown)="startDrag($event, 'research', time)"
                            (mouseenter)="onMouseEnter('research', time)" (mouseup)="stopDrag()"
                            (touchstart)="startDrag($event, 'research', time)" (touchend)="stopDrag()">
                            {{ time }}
                        </button>
                        }
                    </div>
                </div>

                <div class="boost-section">
                    <h4>Troops ({{ evt.troopsDay | titlecase }})</h4>
                    <div class="time-grid" (mouseleave)="stopDrag()" (touchmove)="handleTouchMove($event, 'troops')">
                        @for (time of timeSlots(); track time) {
                        <button class="time-slot" [attr.data-time]="time" [class.selected]="isSelected('troops', time)"
                            (mousedown)="startDrag($event, 'troops', time)" (mouseenter)="onMouseEnter('troops', time)"
                            (mouseup)="stopDrag()" (touchstart)="startDrag($event, 'troops', time)"
                            (touchend)="stopDrag()">
                            {{ time }}
                        </button>
                        }
                    </div>
                </div>
                }

                <div class="boost-section image-section">
                    <h4>Backpack Screenshots (Required: 2)</h4>
                    <p class="hint">Please upload 2 screenshots showing your backpack items for verification.</p>

                    <div class="file-input-container">
                        <input type="file" (change)="onFileSelected($event)" accept="image/*" multiple
                            [disabled]="uploadedImageUrls().length + selectedFiles().length >= 2">
                        <span class="file-count">{{ uploadedImageUrls().length + selectedFiles().length }} / 2</span>
                    </div>

                    <div class="images-preview">
                        <!-- Existing Uploaded Images -->
                        @for (url of uploadedImageUrls(); track url) {
                        <div class="image-thumb">
                            <img [src]="url" alt="Uploaded backpack" target="_blank">
                            <button class="remove-btn" (click)="removeUploadedImage(url)">×</button>
                        </div>
                        }

                        <!-- New Selected Files -->
                        @for (file of selectedFiles(); track file.name; let i = $index) {
                        <div class="file-item">
                            <span>{{ file.name }}</span>
                            <button class="remove-btn" (click)="removeFile(i)">×</button>
                        </div>
                        }
                    </div>
                </div>

                <div class="actions">
                    <button class="save-btn" (click)="save(char.id)" [disabled]="saving()">
                        {{ saving() ? 'Saving...' : 'Save Registration' }}
                    </button>
                </div>
            </div>
            }
        </div>
        }
    </div>

    } @else {
    <div class="no-events">
        <h2>No active SvS Prep events found.</h2>
    </div>
    }
    }
</div>