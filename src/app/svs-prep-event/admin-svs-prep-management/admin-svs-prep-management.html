<div class="container">
    <div class="header">
        <a routerLink="/admin/svs-prep" class="back-link">← Back to List</a>
        @if (event(); as evt) {
        <h1>Manage Event: Server {{ evt.server }}</h1>
        <p>Battle Date: {{ evt.date.seconds * 1000 | date:'longDate' }}</p>
        } @else {
        <h1>Loading Event...</h1>
        }
    </div>

    <div class="manual-add-section">
        <h3>Manual Registration</h3>
        <div class="add-form">
            <input type="text" placeholder="Character Name" [ngModel]="newManualName()"
                (ngModelChange)="newManualName.set($event)" />
            <button (click)="addManualRegistration()" [disabled]="!newManualName() || isAdding()">Add</button>
        </div>
    </div>

    <div class="registrations-section">
        <h2>Registrations ({{ registrations().length }})</h2>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Character</th>
                        <th>Construction Slots</th>
                        <th>Research Slots</th>
                        <th>Troops Slots</th>
                        <th>Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @for (reg of registrations(); track reg.id) {
                    <tr [class.manual-row]="reg.isManual">
                        <td>
                            <div class="user-info">
                                <span class="char-name">{{ reg.characterName || 'Unknown Character' }}</span>
                                @if (reg.characterVerified) {
                                <span class="verified-badge" title="Verified Character">✓ Verified</span>
                                } @else {
                                @if (reg.isManual) {
                                <span class="manual-badge" title="Manual Entry">✎ Manual</span>
                                } @else {
                                <span class="unverified-badge" title="Unverified Character">⚠ Unverified</span>
                                }
                                }
                            </div>
                        </td>
                        <td>
                            @for (pref of reg.preferences; track pref.boostType) {
                            @if (pref.boostType === 'construction') {
                            <div class="slots-list">
                                @for (slot of pref.slots; track slot) {
                                <span class="slot-tag">{{ slot }}</span>
                                }
                            </div>
                            }
                            }
                        </td>
                        <td>
                            @for (pref of reg.preferences; track pref.boostType) {
                            @if (pref.boostType === 'research') {
                            <div class="slots-list">
                                @for (slot of pref.slots; track slot) {
                                <span class="slot-tag">{{ slot }}</span>
                                }
                            </div>
                            }
                            }
                        </td>
                        <td>
                            @for (pref of reg.preferences; track pref.boostType) {
                            @if (pref.boostType === 'troops') {
                            <div class="slots-list">
                                @for (slot of pref.slots; track slot) {
                                <span class="slot-tag">{{ slot }}</span>
                                }
                            </div>
                            }
                            }
                        </td>
                        <td>{{ reg.updatedAt.seconds * 1000 | date:'short' }}</td>
                        <td>
                            @if (reg.isManual) {
                            <button class="action-btn edit" (click)="toggleEdit(reg.id!)">Edit</button>
                            <button class="action-btn delete" (click)="deleteReg(reg)">Del</button>
                            }
                        </td>
                    </tr>
                    @if (editingRegId() === reg.id && reg.isManual) {
                    <tr class="edit-row">
                        <td colspan="6">
                            <div class="edit-panel">
                                <h4>Edit Slots for {{ reg.characterName }}</h4>
                                @if (event(); as evt) {
                                <div class="edit-grids">
                                    <div class="edit-group">
                                        <h5>Construction ({{ evt.constructionDay }})</h5>
                                        <app-svs-boost-grid [boostType]="'construction'" [slots]="timeSlots()"
                                            [selectedMs]="getSlotsFor(reg, 'construction')"
                                            (selectionChange)="updateSlots(reg, 'construction', $event)">
                                        </app-svs-boost-grid>
                                    </div>
                                    <div class="edit-group">
                                        <h5>Research ({{ evt.researchDay }})</h5>
                                        <app-svs-boost-grid [boostType]="'research'" [slots]="timeSlots()"
                                            [selectedMs]="getSlotsFor(reg, 'research')"
                                            (selectionChange)="updateSlots(reg, 'research', $event)">
                                        </app-svs-boost-grid>
                                    </div>
                                    <div class="edit-group">
                                        <h5>Troops ({{ evt.troopsDay }})</h5>
                                        <app-svs-boost-grid [boostType]="'troops'" [slots]="timeSlots()"
                                            [selectedMs]="getSlotsFor(reg, 'troops')"
                                            (selectionChange)="updateSlots(reg, 'troops', $event)">
                                        </app-svs-boost-grid>
                                    </div>
                                </div>
                                }
                                <button class="close-edit" (click)="toggleEdit(reg.id!)">Done</button>
                            </div>
                        </td>
                    </tr>
                    }
                    } @empty {
                    <tr>
                        <td colspan="6" class="empty-state">No registrations yet.</td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>