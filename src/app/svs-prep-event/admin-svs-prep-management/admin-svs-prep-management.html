<div class="container">
    <div class="header">
        <a routerLink="/admin/svs-prep" class="back-link">← Back to List</a>
        @if (event(); as evt) {
        <h1>Manage Event: Server {{ evt.server }}</h1>
        <p>Battle Date: {{ evt.date.seconds * 1000 | date:'longDate' }}</p>
        } @else {
        <h1>Loading Event...</h1>
        }
    </div>

    <div class="view-tabs">
        <button [class.active]="view() === 'registrations'" (click)="view.set('registrations')">Registrations</button>
        <button [class.active]="view() === 'schedule'" (click)="view.set('schedule')">Schedule</button>
    </div>

    @if (view() === 'registrations') {
    <div class="manual-add-section">

        <h3>Manual Registration</h3>
        <div class="add-form">
            <input type="text" placeholder="Character Name" [ngModel]="newManualName()"
                (ngModelChange)="newManualName.set($event)" />
            <button (click)="addManualRegistration()" [disabled]="!newManualName() || isAdding()">Add</button>
        </div>
    </div>

    <div class="registrations-section">
        <h2>Registrations ({{ registrations().length }})</h2>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Character</th>
                        <th>Images</th>
                        <th>Construction Slots</th>
                        <th>Research Slots</th>
                        <th>Troops Slots</th>
                        <th>Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @for (reg of registrations(); track reg.id) {
                    <tr [class.manual-row]="reg.isManual">
                        <td>
                            <div class="user-info">
                                <span class="char-name">{{ reg.characterName || 'Unknown Character' }}</span>
                                @if (reg.characterVerified) {
                                <span class="verified-badge" title="Verified Character">✓ Verified</span>
                                } @else {
                                @if (reg.isManual) {
                                <span class="manual-badge" title="Manual Entry">✎ Manual</span>
                                } @else {
                                <span class="unverified-badge" title="Unverified Character">⚠ Unverified</span>
                                }
                                }
                            </div>
                        </td>

                        <td>
                            <div class="image-list">
                                @for (img of reg.backpackImages; track img) {
                                <a [href]="img" target="_blank">
                                    <img [src]="img" class="table-thumb" alt="Backpack" loading="lazy">
                                </a>
                                } @empty {
                                <span class="no-images">-</span>
                                }
                            </div>
                        </td>
                        <td>
                            @for (pref of reg.preferences; track pref.boostType) {
                            @if (pref.boostType === 'construction') {
                            <div class="slots-list">
                                @for (slot of pref.slots; track slot) {
                                <span class="slot-tag">{{ slot }}</span>
                                }
                            </div>
                            }
                            }
                        </td>
                        <td>
                            @for (pref of reg.preferences; track pref.boostType) {
                            @if (pref.boostType === 'research') {
                            <div class="slots-list">
                                @for (slot of pref.slots; track slot) {
                                <span class="slot-tag">{{ slot }}</span>
                                }
                            </div>
                            }
                            }
                        </td>
                        <td>
                            @for (pref of reg.preferences; track pref.boostType) {
                            @if (pref.boostType === 'troops') {
                            <div class="slots-list">
                                @for (slot of pref.slots; track slot) {
                                <span class="slot-tag">{{ slot }}</span>
                                }
                            </div>
                            }
                            }
                        </td>
                        <td>{{ reg.updatedAt.seconds * 1000 | date:'short' }}</td>
                        <td>
                            @if (reg.isManual) {
                            <button class="action-btn edit" (click)="toggleEdit(reg.id!)">Edit</button>
                            <button class="action-btn delete" (click)="deleteReg(reg)">Del</button>
                            }
                        </td>
                    </tr>
                    @if (editingRegId() === reg.id && reg.isManual) {
                    <tr class="edit-row">
                        <td colspan="6">
                            <div class="edit-panel">
                                <h4>Edit Slots for {{ reg.characterName }}</h4>
                                @if (event(); as evt) {
                                <div class="time-controls"
                                    style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border-default);">
                                    <div class="quick-entry" style="margin-bottom: 16px;">
                                        <label
                                            style="display: block; margin-bottom: 8px; color: var(--text-secondary);">Quick
                                            Entry (e.g. "10-12")</label>
                                        <div style="display: flex; gap: 8px;">
                                            <input type="text" [ngModel]="editingTimeRangeInput()"
                                                (ngModelChange)="editingTimeRangeInput.set($event)"
                                                placeholder="Enter range..."
                                                style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border-default); background: var(--surface-card); color: var(--text-primary);">
                                            <button (click)="applyEditingTimeRange(reg)"
                                                style="padding: 8px 16px; background: var(--surface-card); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary); cursor: pointer;">Apply</button>
                                        </div>
                                    </div>

                                    <div class="toggle-control">
                                        <label
                                            style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--text-primary);">
                                            <input type="checkbox" [ngModel]="editingSameTimeForAll()"
                                                (ngModelChange)="editingSameTimeForAll.set($event)">
                                            Same time for Construction, Research, and Troops
                                        </label>
                                    </div>
                                </div>

                                @if (editingSameTimeForAll()) {
                                <div class="edit-grids">
                                    <div class="edit-group">
                                        <h5>General Availability (All Days)</h5>
                                        <app-svs-boost-grid [boostType]="'construction'" [slots]="timeSlots()"
                                            [selectedMs]="getSlotsFor(reg, 'construction')"
                                            (selectionChange)="updateSlotsUnified(reg, $event)">
                                        </app-svs-boost-grid>
                                        <!-- Note: Using 'construction' slots as the source of truth for display since they are all synced -->
                                    </div>
                                </div>
                                } @else {
                                <div class="edit-grids">
                                    <div class="edit-group">
                                        <h5>Construction ({{ evt.constructionDay }})</h5>
                                        <app-svs-boost-grid [boostType]="'construction'" [slots]="timeSlots()"
                                            [selectedMs]="getSlotsFor(reg, 'construction')"
                                            (selectionChange)="updateSlots(reg, 'construction', $event)">
                                        </app-svs-boost-grid>
                                    </div>
                                    <div class="edit-group">
                                        <h5>Research ({{ evt.researchDay }})</h5>
                                        <app-svs-boost-grid [boostType]="'research'" [slots]="timeSlots()"
                                            [selectedMs]="getSlotsFor(reg, 'research')"
                                            (selectionChange)="updateSlots(reg, 'research', $event)">
                                        </app-svs-boost-grid>
                                    </div>
                                    <div class="edit-group">
                                        <h5>Troops ({{ evt.troopsDay }})</h5>
                                        <app-svs-boost-grid [boostType]="'troops'" [slots]="timeSlots()"
                                            [selectedMs]="getSlotsFor(reg, 'troops')"
                                            (selectionChange)="updateSlots(reg, 'troops', $event)">
                                        </app-svs-boost-grid>
                                    </div>
                                </div>
                                }
                                }
                                <button class="close-edit" (click)="toggleEdit(reg.id!)">Done</button>
                            </div>
                        </td>
                    </tr>
                    }
                    } @empty {
                    <tr>
                        <td colspan="6" class="empty-state">No registrations yet.</td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    }

    @if (view() === 'schedule') {
    <div class="schedule-section">
        <div class="schedule-actions">
            <button class="action-btn schedule-run" (click)="runSchedule()">Run Schedule (Greedy)</button>
        </div>

        <div class="schedule-grid" *ngIf="event() as evt">
            <!-- Construction -->
            <div class="schedule-column">
                <div class="column-header">
                    <h3>Construction ({{ evt.constructionDay }})</h3>
                    <button class="clear-btn" (click)="clearDay('construction')"
                        title="Clear all construction assignments">Clear</button>
                </div>
                <div class="slot-list">
                    @for (slot of timeSlots(); track slot) {
                    <div class="slot-row" [class.assigned]="getAssignedName('construction', slot)">
                        <span class="slot-time">{{ slot }}</span>
                        <div class="slot-assignment">
                            @if (getAssignedName('construction', slot); as name) {
                            <span class="assigned-name">{{ name }}</span>
                            <button class="unassign-btn" (click)="unassign('construction', slot)">×</button>
                            } @else {
                            @if (assigningSlot()?.type === 'construction' && assigningSlot()?.slot === slot) {
                            <div class="manual-assign-form" style="display: flex; gap: 4px;">
                                <select [ngModel]="manualAssignmentId()"
                                    (ngModelChange)="manualAssignmentId.set($event)">
                                    <option [value]="null">Select Player</option>
                                    @for (reg of unassignedConstruction(); track reg.characterId) {
                                    <option [value]="reg.characterId">{{ reg.characterName }}</option>
                                    }
                                </select>
                                <button (click)="saveManualAssignment()">✓</button>
                                <button (click)="cancelAssigning()">✕</button>
                            </div>
                            } @else {
                            <span class="empty-slot">-</span>
                            <button class="manual-assign-btn" (click)="startAssigning('construction', slot)">+</button>
                            }
                            }
                        </div>
                    </div>
                    }
                </div>
            </div>

            <!-- Research -->
            <div class="schedule-column">
                <div class="column-header">
                    <h3>Research ({{ evt.researchDay }})</h3>
                    <button class="clear-btn" (click)="clearDay('research')"
                        title="Clear all research assignments">Clear</button>
                </div>
                <div class="slot-list">
                    @for (slot of timeSlots(); track slot) {
                    <div class="slot-row" [class.assigned]="getAssignedName('research', slot)">
                        <span class="slot-time">{{ slot }}</span>
                        <div class="slot-assignment">
                            @if (getAssignedName('research', slot); as name) {
                            <span class="assigned-name">{{ name }}</span>
                            <button class="unassign-btn" (click)="unassign('research', slot)">×</button>
                            } @else {
                            @if (assigningSlot()?.type === 'research' && assigningSlot()?.slot === slot) {
                            <div class="manual-assign-form" style="display: flex; gap: 4px;">
                                <select [ngModel]="manualAssignmentId()"
                                    (ngModelChange)="manualAssignmentId.set($event)">
                                    <option [value]="null">Select Player</option>
                                    @for (reg of unassignedResearch(); track reg.characterId) {
                                    <option [value]="reg.characterId">{{ reg.characterName }}</option>
                                    }
                                </select>
                                <button (click)="saveManualAssignment()">✓</button>
                                <button (click)="cancelAssigning()">✕</button>
                            </div>
                            } @else {
                            <span class="empty-slot">-</span>
                            <button class="manual-assign-btn" (click)="startAssigning('research', slot)">+</button>
                            }
                            }
                        </div>
                    </div>
                    }
                </div>
            </div>

            <!-- Troops -->
            <div class="schedule-column">
                <div class="column-header">
                    <h3>Troops ({{ evt.troopsDay }})</h3>
                    <button class="clear-btn" (click)="clearDay('troops')"
                        title="Clear all troops assignments">Clear</button>
                </div>
                <div class="slot-list">
                    @for (slot of timeSlots(); track slot) {
                    <div class="slot-row" [class.assigned]="getAssignedName('troops', slot)">
                        <span class="slot-time">{{ slot }}</span>
                        <div class="slot-assignment">
                            @if (getAssignedName('troops', slot); as name) {
                            <span class="assigned-name">{{ name }}</span>
                            <button class="unassign-btn" (click)="unassign('troops', slot)">×</button>
                            } @else {
                            @if (assigningSlot()?.type === 'troops' && assigningSlot()?.slot === slot) {
                            <div class="manual-assign-form" style="display: flex; gap: 4px;">
                                <select [ngModel]="manualAssignmentId()"
                                    (ngModelChange)="manualAssignmentId.set($event)">
                                    <option [value]="null">Select Player</option>
                                    @for (reg of unassignedTroops(); track reg.characterId) {
                                    <option [value]="reg.characterId">{{ reg.characterName }}</option>
                                    }
                                </select>
                                <button (click)="saveManualAssignment()">✓</button>
                                <button (click)="cancelAssigning()">✕</button>
                            </div>
                            } @else {
                            <span class="empty-slot">-</span>
                            <button class="manual-assign-btn" (click)="startAssigning('troops', slot)">+</button>
                            }
                            }
                        </div>
                    </div>
                    }
                </div>
            </div>
        </div>

        @if (unassignedRegistrations(); as unassigned) {
        @if (unassigned.length > 0) {
        <div class="unassigned-section"
            style="margin-top: 32px; border-top: 1px solid var(--border-default); padding-top: 24px;">
            <h3>Unassigned Players ({{ unassigned.length }})</h3>
            <p style="color: var(--text-secondary); font-style: italic; margin-bottom: 16px;">
                These players registered preferences but could not be fitted into any slot.
            </p>
            <div class="unassigned-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                @for (reg of unassigned; track reg.id) {
                <div class="unassigned-tag"
                    style="background: var(--surface-hover); padding: 4px 12px; border-radius: 16px; border: 1px solid var(--border-default);">
                    <span class="name">{{ reg.characterName }}</span>
                </div>
                }
            </div>
        </div>
        }
        }
    </div>
    }
</div>