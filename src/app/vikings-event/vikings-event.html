<div class="vikings-container">
    <header class="header">
        <a routerLink="/vikings" class="back-link">‚Üê All Events</a>
        <h1>Vikings Event Details</h1>

        @if (eventData(); as event) {
        <div class="header-actions">
            <div class="pill">Server: {{ event.server }}</div>
            <div class="pill">Alliance: {{ event.allianceTag ? '[' + event.allianceTag + ']' : event.allianceId }}</div>
            <div class="pill status-pill" [class.voting]="event.status === 'voting'"
                [class.final]="event.status === 'finalized'">
                {{ event.status === 'voting' ? 'Voting' : 'Finalized' }}
            </div>
            <a routerLink="/vikings/guide" class="guide-link">üìñ Read Guide</a>
        </div>
        }
    </header>

    @if (eventData(); as event) {
    <div class="event-details">

        @if (event.status === 'voting' && eligibleCharacters().length > 0) {
        <section class="registration-section">
            <h2>üìù Register Your Availability</h2>
            <p class="hint-text">Help the alliance admins plan assignments by registering your active characters.</p>

            <div class="registration-grid">
                @for (char of eligibleCharacters(); track char.id) {
                <div class="registration-card">
                    <h3>{{ char.name }}</h3>

                    @let existingReg = getRegistration(char.id);
                    <form
                        (submit)="$event.preventDefault(); saveRegistration(char.id, statusSelect.value, marchesInput.value)">
                        <div class="form-group">
                            <label>Status</label>
                            <select #statusSelect [value]="existingReg?.status || 'online'">
                                <option value="online">Online</option>
                                <option value="offline_empty">Offline (Empty)</option>
                                <option value="offline_not_empty">Offline (Not Empty)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Marches</label>
                            <input #marchesInput type="number"
                                [value]="existingReg ? existingReg.marchesCount : (char.marches ?? '')"
                                placeholder="Unset" min="1" max="6">
                        </div>

                        <button type="submit" class="save-btn">
                            {{ existingReg ? 'Update' : 'Register' }}
                        </button>
                    </form>
                </div>
                }
            </div>
        </section>
        }

        <h2>Date: {{ event.date?.toDate() | date:'medium' }}</h2>

        <div class="controls">
            <input type="text" placeholder="Search players..." [value]="searchQuery()"
                (input)="setSearch($any($event.target).value)" class="search-input" />
            <div class="sort-controls">
                <button (click)="setSort('name')" [class.active]="sortBy() === 'name'">
                    Name
                    @if (sortBy() === 'name') { {{ sortOrder() === 'asc' ? '‚Üë' : '‚Üì' }} }
                </button>
                <button (click)="setSort('power')" [class.active]="sortBy() === 'power'">
                    Power
                    @if (sortBy() === 'power') { {{ sortOrder() === 'asc' ? '‚Üë' : '‚Üì' }} }
                </button>
            </div>
        </div>

        <div class="assignments-list">
            @if (myCharacters().length > 0) {
            <h3 class="section-header">Your Characters</h3>
            @for (character of myCharacters(); track character.characterId) {
            <div class="player-card active-user-card" [class.expanded]="expandedPlayerId() === character.characterId"
                (click)="toggleCharacter(character.characterId)">
                <div class="player-header">
                    <div style="display: flex; align-items: center;">
                        <span class="status-dot" [class]="character.status" [title]="character.status"></span>
                        <span class="player-name">{{ character.characterName }}</span>
                    </div>
                    <div class="header-right">
                        <span class="player-power">Power: {{ character.powerLevel | number }}</span>
                        <span class="expand-icon">
                            @if (event.status !== 'voting' || isPreview()) {
                            @if (expandedPlayerId() === character.characterId) {
                            ‚ñº
                            } @else {
                            ‚ñ∂
                            }
                            }
                        </span>
                    </div>
                </div>

                @if (expandedPlayerId() === character.characterId) {
                <div class="assignments-details">
                    <div class="details-header">
                        <h3>Priorities</h3>
                        <div class="header-actions">
                            <button class="action-btn" (click)="copyAssignments(character, $event)"
                                title="Copy to clipboard">üìã Copy</button>
                            <button class="action-btn secondary"
                                (click)="openReinforcedBy(character.characterId, $event)"
                                title="See who reinforces this player">üõ°Ô∏è Reinforced By</button>
                        </div>
                    </div>
                    <ul>
                        @for (target of character.reinforce; track target.characterId) {
                        <li>
                            <div style="display: flex; align-items: center;">
                                <span class="status-dot" [class]="target.status" [title]="target.status"></span>
                                <span class="target-name">{{ target.characterName }}</span>
                            </div>
                            <div class="target-info">
                                @if (target.marchType) {
                                <span class="march-type">{{ target.marchType }}</span>
                                }
                                @if (target.powerLevel != null) {
                                <span class="target-power" title="Power">{{ target.powerLevel | number }}</span>
                                }
                            </div>
                        </li>
                        } @empty {
                        <li>No reinforcements assigned.</li>
                        }
                    </ul>
                </div>
                }
            </div>
            }

            <h3 class="section-header">Other Players</h3>
            }

            @for (character of otherCharacters(); track character.characterId) {
            <div class="player-card" [class.expanded]="expandedPlayerId() === character.characterId"
                (click)="toggleCharacter(character.characterId)">
                <div class="player-header">
                    <div style="display: flex; align-items: center;">
                        <span class="status-dot" [class]="character.status" [title]="character.status"></span>
                        <span class="player-name">{{ character.characterName }}</span>
                    </div>
                    <div class="header-right">
                        <span class="player-power">Power: {{ character.powerLevel | number }}</span>
                        <span class="expand-icon">
                            @if (event.status !== 'voting' || isPreview()) {
                            @if (expandedPlayerId() === character.characterId) {
                            ‚ñº
                            } @else {
                            ‚ñ∂
                            }
                            }
                        </span>
                    </div>
                </div>

                @if (expandedPlayerId() === character.characterId) {
                <div class="assignments-details">
                    <div class="details-header">
                        <h3>Priorities</h3>
                        <div class="header-actions">
                            <button class="action-btn" (click)="copyAssignments(character, $event)"
                                title="Copy to clipboard">üìã Copy</button>
                            <button class="action-btn secondary"
                                (click)="openReinforcedBy(character.characterId, $event)"
                                title="See who reinforces this player">üõ°Ô∏è Reinforced By</button>
                        </div>
                    </div>
                    <ul>
                        @for (target of character.reinforce; track target.characterId) {
                        <li>
                            <div style="display: flex; align-items: center;">
                                <span class="status-dot" [class]="target.status" [title]="target.status"></span>
                                <span class="target-name">{{ target.characterName }}</span>
                            </div>
                            <div class="target-info">
                                @if (target.marchType) {
                                <span class="march-type">{{ target.marchType }}</span>
                                }
                                @if (target.powerLevel != null) {
                                <span class="target-power" title="Power">{{ target.powerLevel | number }}</span>
                                }
                            </div>
                        </li>
                        } @empty {
                        <li>No reinforcements assigned.</li>
                        }
                    </ul>
                </div>
                }
            </div>
            } @empty {
            @if (myCharacters().length === 0) {
            <div class="no-data">No assignments found for this event.</div>
            }
            }
        </div>
    </div>
    } @else {
    <div class="loading-state">
        <p>Loading event data or no active event found...</p>
        <p class="hint">Ensure the event ID is correct and the event exists.</p>
    </div>
    }

    @if (showReinforcedByModal()) {
    <div class="modal-backdrop" (click)="closeReinforcedBy()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Reinforced By: {{ currentReinforcedByName() }}</h3>
                <button class="close-btn" (click)="closeReinforcedBy()">√ó</button>
            </div>
            <div class="modal-body">
                @if (currentReinforcedByList().length > 0) {
                <ul class="reinforced-list">
                    @for (source of currentReinforcedByList(); track $index) {
                    <li>
                        <div style="display: flex; align-items: center;">
                            <span class="status-dot" [class]="source.status" [title]="source.status"></span>
                            <span class="source-name">{{ source.name }}</span>
                        </div>
                        <span class="source-power">{{ source.power | number }}</span>
                    </li>
                    }
                </ul>
                } @else {
                <div class="no-data-small">No one is reinforcing this player.</div>
                }
            </div>
        </div>
    </div>
    }
</div>